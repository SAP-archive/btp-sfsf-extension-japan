sap.ui.define(["sap/m/MessageBox","sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/ui/core/Fragment","sap/ui/core/ResizeHandler","sap/ui/core/routing/History","sap/ui/core/syncStyleClass","../model/formatter","./BaseController"],function(t,e,s,i,a,o,n,r,d){"use strict";var h={PHONE:600,TABLET:1024};var g={PHONE:1,TABLET:2,DESKTOP:4};return d.extend("com.sap.sfsf.comparison.Reshuffle_Comparison_UI.controller.Comparison",{onInit:function(){this._oRootControl=this.getOwnerComponent().getRootControl();this.oRouter=this.getOwnerComponent().getRouter();this.oRouter.attachRouteMatched(this.onRouteMatched,this);this._aCachedItems={};this._aAllCandidates=this.getOwnerComponent().getModel().getData();this._aSelectedItems=[];this._iPagesCount=this._getPagesCount(this._oRootControl.$().innerWidth());this._bIsDesktop=this._checkIsDesktop();this._iFirstItem=0;this._iLastItem=this._iPagesCount;this._setModels();this._iResizeHandlerId=a.register(this.getOwnerComponent().getRootControl(),this._onResize.bind(this))},onRouteMatched:function(t){this._aSelectedItems=this.getOwnerComponent().aSelectedItems;this._aSelectedItemsIds=this._getSelectedItemsIds();this._iPagesCount=this._getPagesCount(this._oRootControl.$().innerWidth());this._bIsDesktop=this._checkIsDesktop();this._updateFirstPage();this._aCandidatesToShow=this._getCandidatesToShow(this._aAllCandidates);this.getView().getModel("settings").setData({pagesCount:this._iPagesCount,isDesktop:this._bIsDesktop});this.getView().getModel("candidates").setData(this._aCandidatesToShow)},onAfterRendering:function(){this._oCarouselSnapped=this.getView().byId("carousel-snapped");this._oCarouselExpanded=this.getView().byId("carousel-expanded");this._oDynamicPage=this.getView().byId("dynamic-page")},onPageChanged:function(t){var e=t.getParameter("activePages"),s;this._iFirstItem=e[0];this._iLastItem=e[e.length-1]+1;this._updateCarouselsActivePage();s=this._getModelData(this._aCandidatesToShow.Candidates);this.getView().getModel("candidates").setData(s)},onPanelExpanded:function(t){var e=t.getSource();e.getParent().getContent()[1].getItems().forEach(function(t){t.getItems()[1].setVisible(e.getExpanded())})},onStateChange:function(t){var e=t.getParameter("isExpanded");e&&this._oDynamicPage.removeSnappedContent(this._oCarouselSnapped);!e&&this._oDynamicPage.addSnappedContent(this._oCarouselSnapped)},onNavBack:function(){var t=o.getInstance();var e=t.getPreviousHash();if(e!==undefined){window.history.go(-1)}else{var s=this.getOwnerComponent().getRouter();s.navTo("page1",{},true)}},onJobHistory:function(e,s){var a=e.getSource(),o=this.getView();var n=o.getModel();var r=n.getData();var d=this;$.ajax({url:"/srv_api/jobhistories/"+s,method:"GET",contentType:"application/json",success:function(t,e,s){for(var i of t){if(i.startDate!==null){i.startDate=d._getformatDate(i.startDate)}if(i.endDate!==null){i.endDate=d._getformatDate(i.endDate)}if(i.lastModifiedDate!==null){i.lastModifiedDate=d._getformatDate(i.lastModifiedDate)}}t.sort(function(t,e){return parseFloat(t.bgOrderPos)-parseFloat(e.bgOrderPos)});r.jobHistory=t;n.setData(r);n.refresh(true)},error:function(e,s,i){t.error("list error")}});this.getView().setModel(n);if(!this._pPopover){this._pPopover=i.load({id:o.getId(),name:"com.sap.sfsf.comparison.Reshuffle_Comparison_UI.view.fragment.JobHistory",controller:this}).then(function(t){o.addDependent(t);return t})}this._pPopover.then(function(t){t.openBy(a)})},_getformatDate:function(t){var e=new Date(Number(t.replace(/\D/g,""))),s=""+(e.getMonth()+1),i=""+e.getDate(),a=e.getFullYear();if(s.length<2)s="0"+s;if(i.length<2)i="0"+i;return[a,s,i].join("/")},_onResize:function(t){var e=t.size.width,s=this._getPagesCount(e);if(s!==this._iPagesCount){this._iPagesCount=s;this.getView().getModel("settings").setProperty("/pagesCount",this._iPagesCount);this._bIsDesktop=this._checkIsDesktop();this.getView().getModel("settings").setProperty("/isDesktop",this._bIsDesktop);this._updateFirstPage();this._updateCandidatesData()}},_updateFirstPage:function(){var t=this._aSelectedItems.length;if(this._iFirstItem+this._iPagesCount>t){this._iFirstItem=t-this._iPagesCount;this._updateCarouselsActivePage()}},_updateCarouselsActivePage:function(){this._oCarouselSnapped.setActivePage(this._oCarouselSnapped.getPages()[this._iFirstItem]);this._oCarouselExpanded.setActivePage(this._oCarouselExpanded.getPages()[this._iFirstItem])},_setModels:function(){this.getView().setModel(new s,"settings");this.getView().setModel(new s,"candidates")},_updateCandidatesData:function(){var t=this._getModelData(this._aCandidatesToShow.Candidates);this.getView().getModel("candidates").setData(t)},_getPagesCount:function(t){var e=this._aSelectedItems.length,s;if(t<=h.PHONE){s=g.PHONE}else if(t<=h.TABLET){s=g.TABLET}else{s=g.DESKTOP}if(e&&s>e){s=e}return s},_checkIsDesktop:function(){return this._iPagesCount===g.DESKTOP},_getSelectedItemsIds:function(){return this._aSelectedItems.map(function(t){return parseInt(t.split("/").pop())})},_getCandidatesToShow:function(t){var e=[];this._aSelectedItemsIds.forEach(function(s){e.push(t.list[s])});return this._getModelData(e)},_getModelData:function(t){var e=[],s=this._iFirstItem+this._iPagesCount,i,a,o,n;this._iLastItem=s>t.length?t.length:s;for(var r in t[0]){if(t[0].hasOwnProperty(r)&&r!=="caseId"&&r!=="candidateID"&&r!=="candidateName"&&r!=="candidateDivisionName"&&r!=="candidateDepartmentName"&&r!=="candidatePositionName"&&r!=="divisionName"&&r!=="departmentName"&&r!=="positionName"&&r!=="modifiedAt"&&r!=="modifiedBy"&&r!=="createdAt"&&r!=="createdBy"){i={};i.key=this.getResourceText(r);i.values=[];for(var d=this._iFirstItem;d<this._iLastItem;d++){a=t[d];o=this._aCachedItems[a.candidateID]&&this._aCachedItems[a.candidateID][r];if(o){i.values.push(o)}else{if(r=="candidateDivision"){n={text:"<strong>"+t[d][r]+" : "+t[d]["candidateDivisionName"]+"</strong>"}}else if(r=="candidateDepartment"){n={text:"<strong>"+t[d][r]+" : "+t[d]["candidateDepartmentName"]+"</strong>"}}else if(r=="candidatePosition"){n={text:"<strong>"+t[d][r]+" : "+t[d]["candidatePositionName"]+"</strong>"}}else if(r=="division"){n={text:"<strong>"+t[d][r]+" : "+t[d]["divisionName"]+"</strong>"}}else if(r=="Department"){n={text:"<strong>"+t[d][r]+" : "+t[d]["departmentName"]+"</strong>"}}else if(r=="position"){n={text:"<strong>"+t[d][r]+" : "+t[d]["positionName"]+"</strong>"}}else{n={text:"<strong>"+t[d][r]+"</strong>"}}i.values.push(n);this._cacheCandidateInformation(a,r,n)}}e.push(i)}}return{Candidates:t,Props:e}},_cacheCandidateInformation:function(t,e,s){var i=t.CandidateID;if(!this._aCachedItems[i]){this._aCachedItems[i]={}}this._aCachedItems[i][e]=s}})});